#include <stdafx.h>

#include "Image.h"

void SaveVulnerabilityPatch(const Image* apImage)
{
    const mem::pattern cPattern("B8 FF 01 00 00 48 8B F7 48 3B F8 48 8B D3 49 8B");
    const mem::default_scanner cScanner(cPattern);
    auto pLocation = cScanner(apImage->TextRegion).as<uint8_t*>();

    if(pLocation == nullptr)
    {
        spdlog::warn("Save vulnerability patch: failed, could not be found");
        return;
    }

    DWORD oldProtect = 0;
    VirtualProtect(pLocation, 32, PAGE_EXECUTE_WRITECOPY, &oldProtect);
    pLocation[2] = 0;
    VirtualProtect(pLocation, 32, oldProtect, nullptr);

    spdlog::info("Save vulnerability patch: success");
}
